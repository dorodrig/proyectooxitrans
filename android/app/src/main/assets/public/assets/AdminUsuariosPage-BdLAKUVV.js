import{r as c,u as L,a as d,b as F,c as h,j as s,d as g}from"./index-6Tc4nVY8.js";import{u as E}from"./useMutation-BcgxUEpT.js";import{c as M}from"./cargosService-Dp84UuBb.js";const B=()=>{const[f,A]=c.useState(""),[i,C]=c.useState(""),[j,N]=c.useState(!1),[x,l]=c.useState(null),r=L(),u=d(e=>e.logout),P=d(e=>e.isAuthenticated),U=d(e=>e.isLoading),t=F(),V=localStorage.getItem("auth_token"),{data:y,isLoading:S,error:w}=h({queryKey:["usuarios",i],queryFn:async()=>{if(!V)throw await u(),t("/login"),new Error("Token no encontrado, redirigiendo a login");try{return await g.getAll(1,50,i)}catch(e){throw e instanceof Error&&e.message.toLowerCase().includes("401")&&(N(!0),await u(),t("/login")),e}},enabled:P&&!U}),b=y?.data?.usuarios||[],{data:Q}=h({queryKey:["cargos"],queryFn:M.getAll}),q=Q||[],p=E({mutationFn:async({id:e,cargo:n})=>g.asignarCargo(e,n),onSuccess:()=>{r.invalidateQueries({queryKey:["usuarios"]})}}),v=E({mutationFn:async({id:e,nuevoEstado:n})=>{l(null);try{const a=await g.toggleStatus(e,n);return a&&typeof a=="object"&&"data"in a&&a.data?a.data:a||null}catch(a){throw a instanceof Error&&a.message.toLowerCase().includes("401")&&(N(!0),await u(),t("/login")),a instanceof Error?l(a.message||"Error al cambiar el estado del usuario"):l("Error al cambiar el estado del usuario"),a}},onMutate:async({id:e,nuevoEstado:n})=>{await r.cancelQueries({queryKey:["usuarios"]});const a=r.getQueryData(["usuarios",i]);return r.setQueryData(["usuarios",i],o=>{if(!o||typeof o!="object")return o;const D=o?.data?.usuarios;return D?{...o??{},data:{...o.data,usuarios:D.map(m=>m.id===e?{...m,estado:n}:m)}}:o}),{previousData:a}},onError:(e,n,a)=>{a?.previousData&&r.setQueryData(["usuarios",i],a.previousData)},onSettled:()=>{r.invalidateQueries({queryKey:["usuarios"]})}}),k=e=>{e.preventDefault(),C(f)},K=e=>{const n=e.estado==="activo"?"inactivo":"activo";v.mutate({id:e.id,nuevoEstado:n})};return s.jsxDEV("div",{className:"admin-usuarios-page",children:[s.jsxDEV("h1",{className:"text-2xl font-bold mb-4",children:"Administraci贸n de Usuarios"},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:131,columnNumber:7},void 0),j&&s.jsxDEV("div",{className:"mb-4 p-2 bg-red-100 text-red-700 rounded",children:"Tu sesi贸n ha expirado. Por favor inicia sesi贸n nuevamente."},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:133,columnNumber:9},void 0),x&&s.jsxDEV("div",{className:"mb-2 p-2 bg-red-100 text-red-700 rounded",children:x},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:138,columnNumber:9},void 0),s.jsxDEV("div",{className:"acciones-usuarios",children:[s.jsxDEV("form",{onSubmit:k,children:[s.jsxDEV("input",{type:"text",placeholder:"Buscar por nombre o documento...",value:f,onChange:e=>A(e.target.value),className:"form-input w-full max-w-xs"},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:144,columnNumber:11},void 0),s.jsxDEV("button",{type:"submit",className:"btn-primary",children:"Buscar"},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:151,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:143,columnNumber:9},void 0),s.jsxDEV("button",{className:"btn-primary asignar-roles-btn",onClick:()=>t("/admin/asignar-roles"),children:"Asignar Roles"},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:153,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:142,columnNumber:7},void 0),S?s.jsxDEV("p",{children:"Cargando usuarios..."},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:161,columnNumber:9},void 0):w?s.jsxDEV("p",{className:"text-red-500",children:"Error al cargar usuarios"},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:163,columnNumber:9},void 0):s.jsxDEV("table",{className:"w-full table-auto border",children:[s.jsxDEV("thead",{children:s.jsxDEV("tr",{children:[s.jsxDEV("th",{children:"Nombre"},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:168,columnNumber:15},void 0),s.jsxDEV("th",{children:"Documento"},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:169,columnNumber:15},void 0),s.jsxDEV("th",{children:"Rol"},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:170,columnNumber:15},void 0),s.jsxDEV("th",{children:"Cargo"},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:171,columnNumber:15},void 0),s.jsxDEV("th",{children:"Estado"},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:172,columnNumber:15},void 0),s.jsxDEV("th",{children:"Acci贸n"},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:173,columnNumber:15},void 0)]},void 0,!0,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:167,columnNumber:13},void 0)},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:166,columnNumber:11},void 0),s.jsxDEV("tbody",{children:b.length>0?b.map(e=>s.jsxDEV("tr",{children:[s.jsxDEV("td",{children:[e.nombre," ",e.apellido]},void 0,!0,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:180,columnNumber:19},void 0),s.jsxDEV("td",{children:e.documento},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:181,columnNumber:19},void 0),s.jsxDEV("td",{children:e.rol},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:182,columnNumber:19},void 0),s.jsxDEV("td",{children:s.jsxDEV("div",{className:"lista-cargos-usuario",children:s.jsxDEV("select",{value:e.cargo||"",onChange:n=>p.mutate({id:e.id,cargo:n.target.value}),className:"cargo-item",disabled:p.isPending,children:[s.jsxDEV("option",{value:"",children:"Sin cargo"},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:191,columnNumber:25},void 0),q.map(n=>s.jsxDEV("option",{value:n.nombre,children:n.nombre},n.id,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:193,columnNumber:27},void 0))]},void 0,!0,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:185,columnNumber:23},void 0)},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:184,columnNumber:21},void 0)},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:183,columnNumber:19},void 0),s.jsxDEV("td",{children:e.estado},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:198,columnNumber:19},void 0),s.jsxDEV("td",{children:s.jsxDEV("button",{className:`btn ${e.estado==="activo"?"btn-danger":"btn-success"}`,onClick:()=>K(e),disabled:v.isPending,children:e.estado==="activo"?"Desactivar":"Activar"},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:200,columnNumber:21},void 0)},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:199,columnNumber:19},void 0)]},e.id,!0,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:179,columnNumber:17},void 0)):s.jsxDEV("tr",{children:s.jsxDEV("td",{colSpan:5,className:"text-center",children:"No se encontraron usuarios"},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:212,columnNumber:17},void 0)},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:211,columnNumber:15},void 0)},void 0,!1,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:176,columnNumber:11},void 0)]},void 0,!0,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:165,columnNumber:9},void 0)]},void 0,!0,{fileName:"C:/Development/oxitrans-control-acceso/src/pages/AdminUsuariosPage.tsx",lineNumber:130,columnNumber:5},void 0)};export{B as default};
